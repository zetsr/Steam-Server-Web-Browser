<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服务器列表</title>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1a1a1a;
            color: #c0c0c0;
        }
        /* H1 removed */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            background-color: #252525;
            border: 2px solid #404040;
            box-shadow: inset 0 0 5px #000, 0 2px 5px rgba(0,0,0,0.5);
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #404040;
            padding: 8px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-sizing: border-box;
            vertical-align: middle;
        }
        th {
            background: linear-gradient(to bottom, #4d4d4d, #333);
            color: #d0d0d0;
            font-weight: bold;
            text-shadow: 0 1px 1px #000;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        td {
            background-color: #2a2a2a;
            max-width: 200px;
        }
        tr.zero-players td {
            background-color: #202020;
            color: #808080;
        }
        tr:hover td {
            background-color: #3a3a3a;
            color: #fff;
        }
        .ip-link {
            color: inherit;
            text-decoration: none;
            cursor: pointer;
        }
        .ip-link:hover {
            text-decoration: underline;
        }
        .controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #222;
            border: 2px solid #404040;
            box-shadow: inset 0 0 3px #000;
        }
        .refresh-btn {
            padding: 8px 16px;
            background: linear-gradient(to bottom, #555, #333);
            color: #d0d0d0;
            border: 2px solid #555;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-shadow: 0 1px 1px #000;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }
        .refresh-btn:hover {
            background: linear-gradient(to bottom, #666, #444);
            border-color: #666;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }
        .refresh-btn:active {
            background: linear-gradient(to bottom, #444, #222);
            border-color: #444;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
        }
        .refresh-btn:disabled {
            background: #333;
            color: #666;
            border-color: #444;
            cursor: not-allowed;
            box-shadow: none;
        }
        .dropdown, .multiselect {
            position: relative;
            display: inline-block;
        }
        .dropdown-btn, .multiselect-btn {
            padding: 8px 16px;
            font-size: 14px;
            border: 2px solid #555;
            border-radius: 4px;
            background: linear-gradient(to bottom, #555, #333);
            color: #d0d0d0;
            cursor: pointer;
            width: 150px;
            text-align: left;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            position: relative;
        }
        .dropdown-btn::after, .multiselect-btn::after {
            content: '▼';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #d0d0d0;
            font-size: 10px;
        }
        .dropdown-btn:hover, .multiselect-btn:hover {
            background: linear-gradient(to bottom, #666, #444);
            border-color: #666;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }
        .dropdown-btn:active, .multiselect-btn:active {
            background: linear-gradient(to bottom, #444, #222);
            border-color: #444;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
        }
        .dropdown-content, .multiselect-content {
            display: none;
            position: absolute;
            background: #252525;
            border: 2px solid #404040;
            border-radius: 2px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 3;
            width: 150px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            /* Firefox 滚动条暗色风格 */
            scrollbar-width: thin;
            scrollbar-color: #555 #252525;
        }
        /* WebKit/Chromium 桌面端滚动条样式 */
        .dropdown-content::-webkit-scrollbar,
        .multiselect-content::-webkit-scrollbar {
            width: 8px;
        }
        .dropdown-content::-webkit-scrollbar-track,
        .multiselect-content::-webkit-scrollbar-track {
            background: #252525;
        }
        .dropdown-content::-webkit-scrollbar-thumb,
        .multiselect-content::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 4px;
            border: 2px solid #252525;
        }
        .dropdown-content::-webkit-scrollbar-thumb:hover,
        .multiselect-content::-webkit-scrollbar-thumb:hover {
            background-color: #666;
        }
        .dropdown-content div {
            padding: 6px 8px;
            cursor: pointer;
            color: #c0c0c0;
        }
        .dropdown-content div:hover {
            background-color: #3a3a3a;
            color: #fff;
        }
        .multiselect-content {
            padding: 5px 0;
        }
        .multiselect-content label {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            cursor: pointer;
            color: #c0c0c0;
            border-bottom: 1px solid #404040;
        }
        .multiselect-content label:last-child {
            border-bottom: none;
        }
        .multiselect-content label:hover {
            background-color: #3a3a3a;
            color: #fff;
        }
        .multiselect-content input[type="checkbox"] {
            margin-right: 8px;
            accent-color: #d0d0d0;
        }
        .dropdown.open .dropdown-content,
        .multiselect.open .multiselect-content {
            display: block;
        }
        .status-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            position: relative;
            min-height: 40px;
        }
        .status {
            color: #808080;
            text-align: center;
        }
        .last-updated {
            color: #808080;
            text-align: center;
            margin-top: 5px;
        }
        .powered-by {
            color: #d0d0d0;
            font-family: 'Great Vibes', cursive;
            font-size: 16px;
            position: absolute;
            right: 0;
            bottom: 0;
        }
        .powered-by a {
            color: #d0d0d0;
            text-decoration: none;
        }
        .powered-by a:hover {
            text-decoration: underline;
        }
        .flag-icon {
            width: 26px;
            height: 18px;
            vertical-align: middle;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .hidden {
            display: none;
        }
        /* 桌面端列宽度调整 (Original Widths) */
        th.country, td.country { width: 5%; text-align: center; }
        th.game, td.game { width: 10%; }
        th.name, td.name { width: 20%; }
        th.ip, td.ip { width: 15%; }
        th.isp, td.isp { width: 20%; }
        th.os, td.os { width: 8%; }
        th.players, td.players { width: 8%; }
        th.map, td.map { width: 8%; }
        th.version, td.version { width: 8%; }
        th.latency, td.latency { width: 8%; }

        /* Mobile View - Restore original column hiding and widths */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
                margin: 10px;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            .dropdown-btn, .multiselect-btn, .refresh-btn {
                width: 100%;
                margin-bottom: 8px; /* Keep consistent spacing */
                padding: 10px 14px;
                font-size: 14px;
            }
            .table-container {
                overflow-x: auto;
            }
            /* Let table width be determined by content on mobile */
            table {
                 width: 100%; /* Back to 100% to fit screen initially */
                 table-layout: auto; /* Allow columns to adjust slightly */
            }
            th, td {
                font-size: 12px;
                padding: 6px;
            }
            /* Original Mobile Column Visibility & Widths */
            th.country, td.country { width: 15%; display: table-cell; }
            th.game, td.game { width: 25%; display: table-cell; }
            th.name, td.name { width: 40%; display: table-cell; white-space: normal; }
            th.players, td.players { width: 20%; display: table-cell; }

            th.map, td.map,
            th.ip, td.ip,
            th.version, td.version,
            th.latency, td.latency,
            th.os, td.os,
            th.isp, td.isp {
                display: none; /* Hide these columns */
            }

            .powered-by {
                position: static;
                margin-top: 10px;
                text-align: center;
                font-size: 14px;
            }
            .status-container {
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="controls">
        <button class="refresh-btn" onclick="refreshServers()" title="手动请求服务器更新其状态">刷新列表</button>
        <div class="multiselect" id="regionFilter">
            <button class="multiselect-btn" onclick="toggleRegionMultiselect()">选择地区</button>
            <div class="multiselect-content" id="regionFilterOptions"></div>
        </div>
        <div class="multiselect" id="gameFilter">
            <button class="multiselect-btn" onclick="toggleGameMultiselect()">选择游戏</button>
            <div class="multiselect-content" id="gameFilterOptions"></div>
        </div>
        <div class="dropdown" id="sortDropdown">
            <button class="dropdown-btn" onclick="toggleDropdown()">按人数排序</button>
            <div class="dropdown-content" id="sortOptions">
                <div onclick="selectSort('players')">按人数排序</div>
                <div onclick="selectSort('name')">按名称排序</div>
                <div onclick="selectSort('latency')">按延迟排序</div>
            </div>
        </div>
    </div>

    <div class="status-container">
        <div class="status" id="status">正在初始化...</div>
        <div class="last-updated hidden">最后更新于 <span id="updateTime">0</span> 秒之前</div>
        <div class="powered-by"><a href="https://github.com/zetsr" target="_blank">Powered by zetsr</a></div>
    </div>

    <div class="table-container">
        <table id="serverTable">
            <thead>
                <tr>
                    <th class="country">国家</th>
                    <th class="game">游戏名称</th>
                    <th class="name">服务器名称</th>
                    <th class="ip">服务器IP</th>
                    <th class="isp">服务商</th>
                    <th class="os">操作系统</th>
                    <th class="players">在线玩家</th>
                    <th class="map">地图</th>
                    <th class="version">版本</th>
                    <th class="latency">延迟 (ms)</th>
                </tr>
            </thead>
            <tbody id="serverList"></tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const tbody = document.getElementById('serverList');
        const statusDiv = document.getElementById('status');
        const gameFilter = document.getElementById('gameFilter');
        const gameFilterBtn = gameFilter.querySelector('.multiselect-btn');
        const gameFilterOptions = document.getElementById('gameFilterOptions');
        const regionFilter = document.getElementById('regionFilter');
        const regionFilterBtn = regionFilter.querySelector('.multiselect-btn');
        const regionFilterOptions = document.getElementById('regionFilterOptions');
        const sortDropdown = document.getElementById('sortDropdown');
        const sortBtn = sortDropdown.querySelector('.dropdown-btn');
        const updateTimeSpan = document.getElementById('updateTime');
        const lastUpdatedDiv = document.querySelector('.last-updated');

        let serverData = new Map();
        let uniqueGames = new Set();
        let uniqueRegions = new Set();
        let currentSort = 'players';
        let urlParams = parseURLParams();
        let loadingInterval = null;
        let lastUpdateTime = null;
        let updateTimerInterval = null;

        // --- WebSocket Reconnection Logic ---
        let ws = null;
        let reconnectDelay = 5000;
        const maxReconnectDelay = 60000;
        let reconnectTimeoutId = null;
        let reconnectCountdownIntervalId = null;
        // --- End WebSocket Reconnection Logic ---

        function parseURLParams() {
            const params = new URLSearchParams(window.location.search);
            const games = params.get('games') ? params.get('games').split(',').filter(g => g) : [];
            const regions = params.get('regions') ? params.get('regions').split(',').filter(r => r) : [];
            const sort = params.get('sort') || 'players';
            return { games, regions, sort };
        }

        function updateURL() {
            const selectedGames = getSelectedGames();
            const selectedRegions = getSelectedRegions();
            const params = new URLSearchParams();
            if (selectedGames.length > 0) params.set('games', selectedGames.join(','));
            if (selectedRegions.length > 0) params.set('regions', selectedRegions.join(','));
            params.set('sort', currentSort);
            window.history.replaceState({}, document.title, `${window.location.pathname}?${params.toString()}`);
            urlParams = parseURLParams();
        }

        function startLoadingAnimation(message = '已连接，等待服务器数据') {
            let dots = 1;
            clearInterval(loadingInterval);
            clearInterval(reconnectCountdownIntervalId);
            reconnectCountdownIntervalId = null;
            statusDiv.textContent = message + '.';
            loadingInterval = setInterval(() => {
                dots = (dots % 3) + 1;
                statusDiv.textContent = `${message}${'.'.repeat(dots)}`;
            }, 500);
        }

        function stopLoadingAnimation(message) {
            clearInterval(loadingInterval);
            loadingInterval = null;
            if (!reconnectCountdownIntervalId) {
                statusDiv.textContent = message;
            }
        }

        function loadCachedData() {
            const cachedDataStr = sessionStorage.getItem('serverData');
            if (cachedDataStr) {
                try {
                    const cachedData = JSON.parse(cachedDataStr);
                    if (Array.isArray(cachedData)) {
                        cachedData.forEach(server => {
                            const key = `${server.ip}:${server.port}`;
                            serverData.set(key, server);
                        });
                        updateFiltersFromData();
                        applyUrlParamsToFilters();
                        filterAndRenderTable();
                        updateStatus();
                    } else {
                        sessionStorage.removeItem('serverData');
                    }
                } catch (e) {
                    console.error("Failed to parse cached data:", e);
                    sessionStorage.removeItem('serverData');
                }
            } else {
                 updateFiltersFromData();
                 applyUrlParamsToFilters();
            }
        }

        function addOrUpdateServer(server) {
            const key = `${server.ip}:${server.port}`;
            if (!server || typeof server.ip !== 'string' || typeof server.port !== 'number') {
                 console.warn("Received invalid server data:", server);
                 return false;
            }
            serverData.set(key, server);
            const gameDesc = server.game_description || '未知';
            const regionDesc = server.country || 'unknown';
            let filtersChanged = false;
            if (!uniqueGames.has(gameDesc)) {
                 uniqueGames.add(gameDesc);
                 filtersChanged = true;
            }
             if (!uniqueRegions.has(regionDesc)) {
                 uniqueRegions.add(regionDesc);
                 filtersChanged = true;
            }
             if (filtersChanged) {
                 updateFilterOptionsUI();
            }
             return true;
        }

        function updateStatus() {
            const serverCount = serverData.size;
            const gameCount = uniqueGames.size;
            const regionCount = uniqueRegions.size;
            if (!reconnectCountdownIntervalId) {
                stopLoadingAnimation(`已加载 ${serverCount} 个服务器，${gameCount} 个游戏，${regionCount} 个地区。`);
            }
        }

        function connectWebSocket() {
            if (ws && (ws.readyState === WebSocket.CONNECTING || ws.readyState === WebSocket.OPEN)) {
                return;
            }
            clearTimeout(reconnectTimeoutId);
            reconnectTimeoutId = null;
            clearInterval(reconnectCountdownIntervalId);
            reconnectCountdownIntervalId = null;

            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
            statusDiv.textContent = '正在连接服务器...';

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                reconnectDelay = 5000;
                clearInterval(reconnectCountdownIntervalId);
                reconnectCountdownIntervalId = null;
                startLoadingAnimation();
            };

            ws.onmessage = (event) => {
                try {
                    const server = JSON.parse(event.data);
                     let dataAdded = addOrUpdateServer(server);
                     if(dataAdded) {
                        clearTimeout(window.renderTimeout);
                        window.renderTimeout = setTimeout(() => {
                             filterAndRenderTable();
                             updateStatus();
                             updateLastUpdateTime();
                             sessionStorage.setItem('serverData', JSON.stringify(Array.from(serverData.values())));
                        }, 50);
                     }
                } catch (e) {
                    console.error("Error processing WebSocket message:", e, "Data:", event.data);
                }
            };

            ws.onerror = (error) => {
                console.error("WebSocket error:", error);
            };

            ws.onclose = (event) => {
                ws = null;
                if (event.code === 1000 || event.code === 1001) {
                     stopLoadingAnimation('WebSocket 连接已关闭。');
                     clearInterval(reconnectCountdownIntervalId);
                     reconnectCountdownIntervalId = null;
                     return;
                }
                clearInterval(loadingInterval);
                clearInterval(reconnectCountdownIntervalId);

                const reconnectAttemptTime = Date.now() + reconnectDelay;
                const updateCountdown = () => {
                    const now = Date.now();
                    const secondsRemaining = Math.ceil((reconnectAttemptTime - now) / 1000);
                    if (secondsRemaining > 0) {
                        statusDiv.textContent = `连接已断开，${secondsRemaining}秒后尝试重新连接...`;
                    } else {
                        statusDiv.textContent = '正在尝试重新连接...';
                        clearInterval(reconnectCountdownIntervalId);
                        reconnectCountdownIntervalId = null;
                    }
                };
                updateCountdown();
                reconnectCountdownIntervalId = setInterval(updateCountdown, 1000);

                reconnectTimeoutId = setTimeout(connectWebSocket, reconnectDelay);
                reconnectDelay = Math.min(reconnectDelay * 2, maxReconnectDelay);
            };
        }

        function updateFiltersFromData() {
             uniqueGames.clear();
             uniqueRegions.clear();
             serverData.forEach(server => {
                 uniqueGames.add(server.game_description || '未知');
                 uniqueRegions.add(server.country || 'unknown');
             });
             updateFilterOptionsUI();
        }

        function updateFilterOptionsUI() {
             const sortedGames = Array.from(uniqueGames).sort();
             const sortedRegions = Array.from(uniqueRegions).sort();
             initializeFilterOptions(gameFilterOptions, sortedGames, getSelectedGames());
             initializeFilterOptions(regionFilterOptions, sortedRegions, getSelectedRegions(), true);
             updateGameFilterButtonText();
             updateRegionFilterButtonText();
        }

        function applyUrlParamsToFilters() {
            applyCheckboxSelection(gameFilterOptions, urlParams.games);
            applyCheckboxSelection(regionFilterOptions, urlParams.regions);
            updateGameFilterButtonText();
            updateRegionFilterButtonText();
            currentSort = ['players', 'name', 'latency'].includes(urlParams.sort) ? urlParams.sort : 'players';
            sortBtn.textContent = {'players': '按人数排序', 'name': '按名称排序', 'latency': '按延迟排序'}[currentSort];
        }

        function applyCheckboxSelection(optionsContainer, selectedValues) {
             const checkboxes = optionsContainer.querySelectorAll('input[type="checkbox"]');
             checkboxes.forEach(cb => {
                 cb.checked = selectedValues.includes(cb.value);
             });
        }

        function initializeFilterOptions(optionsContainer, items, selectedItems, isRegion = false) {
            optionsContainer.innerHTML = '';
            items.forEach(item => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = item;
                checkbox.checked = selectedItems.includes(item);
                checkbox.addEventListener('change', () => {
                    filterAndRenderTable();
                    if (isRegion) updateRegionFilterButtonText();
                    else updateGameFilterButtonText();
                    updateURL();
                });
                label.appendChild(checkbox);
                if (isRegion && item !== 'unknown') {
                    const flagImg = document.createElement('img');
                    flagImg.src = `https://flagcdn.com/w40/${item.toLowerCase()}.png`;
                    flagImg.alt = item;
                    flagImg.className = 'flag-icon';
                    flagImg.onerror = (e) => { e.target.style.display = 'none'; };
                    label.appendChild(flagImg);
                    label.appendChild(document.createTextNode(` ${item}`));
                } else {
                     label.appendChild(document.createTextNode(item || '未知'));
                 }
                optionsContainer.appendChild(label);
            });
        }

        function getSelectedGames() {
            return Array.from(gameFilterOptions.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        }

        function getSelectedRegions() {
            return Array.from(regionFilterOptions.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        }

        function updateGameFilterButtonText() {
            const selectedGames = getSelectedGames();
            const count = selectedGames.length;
            if (count === 0) {
                gameFilterBtn.textContent = '选择游戏';
                 gameFilterBtn.title = '';
            } else if (count === uniqueGames.size) {
                 gameFilterBtn.textContent = '所有游戏';
                 gameFilterBtn.title = '所有游戏';
            } else {
                gameFilterBtn.textContent = selectedGames.join(', ').substring(0, 15) + (selectedGames.join(', ').length > 15 ? '...' : '');
                 gameFilterBtn.title = selectedGames.join(',');
            }
        }

        function updateRegionFilterButtonText() {
            const selectedRegions = getSelectedRegions();
             const count = selectedRegions.length;
             if (count === 0) {
                 regionFilterBtn.textContent = '选择地区';
                  regionFilterBtn.title = '';
             } else if (count === uniqueRegions.size) {
                 regionFilterBtn.textContent = '所有地区';
                 regionFilterBtn.title = '所有地区';
             } else {
                 regionFilterBtn.textContent = selectedRegions.join(', ').substring(0, 15) + (selectedRegions.join(', ').length > 15 ? '...' : '');
                 regionFilterBtn.title = selectedRegions.join(',');
             }
        }

        function toggleGameMultiselect() {
            gameFilter.classList.toggle('open');
            regionFilter.classList.remove('open');
            sortDropdown.classList.remove('open');
        }

        function toggleRegionMultiselect() {
            regionFilter.classList.toggle('open');
            gameFilter.classList.remove('open');
            sortDropdown.classList.remove('open');
        }

        function toggleDropdown() {
            sortDropdown.classList.toggle('open');
            gameFilter.classList.remove('open');
            regionFilter.classList.remove('open');
        }

        function selectSort(method) {
            currentSort = ['players', 'name', 'latency'].includes(method) ? method : 'players';
            sortBtn.textContent = {'players': '按人数排序', 'name': '按名称排序', 'latency': '按延迟排序'}[currentSort];
            sortDropdown.classList.remove('open');
            filterAndRenderTable();
            updateURL();
        }

        function filterAndRenderTable() {
            const selectedGames = getSelectedGames();
            const selectedRegions = getSelectedRegions();
            let serversToRender = Array.from(serverData.values()).filter(server =>
                (selectedGames.length === 0 || selectedGames.includes(server.game_description || '未知')) &&
                (selectedRegions.length === 0 || selectedRegions.includes(server.country || 'unknown'))
            );
            sortServers(serversToRender);
            renderTable(serversToRender);
        }

        function sortServers(servers) {
            servers.sort((a, b) => {
                if (currentSort === 'players') {
                     const playersDiff = (b.current_players ?? -1) - (a.current_players ?? -1);
                     if (playersDiff !== 0) return playersDiff;
                     return (a.name || '').localeCompare(b.name || '');
                } else if (currentSort === 'name') {
                    return (a.name || '').localeCompare(b.name || '');
                } else if (currentSort === 'latency') {
                     const latA = a.latency ?? Infinity;
                     const latB = b.latency ?? Infinity;
                     const latencyDiff = latA - latB;
                     if (latencyDiff !== 0) return latencyDiff;
                      return (b.current_players ?? -1) - (a.current_players ?? -1);
                 }
                 return 0;
             });
         }

        function renderTable(servers) {
            // 先收集当前所有行
            const existingRows = new Map();
            Array.from(tbody.children).forEach(row => {
                if (row.dataset.key) existingRows.set(row.dataset.key, row);
            });
            const updatedKeys = new Set();

            servers.forEach(server => {
                const key = `${server.ip}:${server.port}`;
                updatedKeys.add(key);
                const countryCode = (server.country || 'unknown').toLowerCase();
                const ipPort = `${server.ip}:${server.port}`;
                const isZeroPlayers = server.current_players === 0;
                let row = existingRows.get(key);

                if (row) {
                    // 更新已有行
                    updateCellContent(row.cells[1], server.game_description || '未知');
                    updateCellContent(row.cells[2], server.name || '未知');
                    const ipLink = row.cells[3].querySelector('.ip-link');
                    if (ipLink && ipLink.textContent !== ipPort) {
                        ipLink.textContent = ipPort;
                        ipLink.href = `steam://connect/${ipPort}`;
                    }
                    updateCellContent(row.cells[4], server.isp || '未知');
                    updateCellContent(row.cells[5], server.os || '未知');
                    updateCellContent(row.cells[6], `${server.current_players ?? '?'}/${server.max_players ?? '?'}`);
                    updateCellContent(row.cells[7], server.map || '未知');
                    updateCellContent(row.cells[8], server.version || '未知');
                    updateCellContent(row.cells[9], server.latency ?? '未知');
                } else {
                    // 新建行
                    row = tbody.insertRow();
                    row.dataset.key = key;
                    row.classList.toggle('zero-players', isZeroPlayers);

                    const cellCountry = row.insertCell();
                    cellCountry.className = 'country';
                    if (countryCode !== 'unknown') {
                        const flagImg = document.createElement('img');
                        flagImg.src = `https://flagcdn.com/w40/${countryCode}.png`;
                        flagImg.alt = server.country || '';
                        flagImg.className = 'flag-icon';
                        flagImg.onerror = e => { e.target.style.display = 'none'; cellCountry.textContent = countryCode.toUpperCase(); };
                        cellCountry.appendChild(flagImg);
                    } else {
                        cellCountry.textContent = '?';
                    }

                    createCell(row, 'game', server.game_description || '未知');
                    createCell(row, 'name', server.name || '未知');
                    const cellIp = createCell(row, 'ip');
                    const link = document.createElement('a');
                    link.href = `steam://connect/${ipPort}`;
                    link.className = 'ip-link';
                    link.textContent = ipPort;
                    cellIp.appendChild(link);
                    createCell(row, 'isp', server.isp || '未知');
                    createCell(row, 'os', server.os || '未知');
                    createCell(row, 'players', `${server.current_players ?? '?'}/${server.max_players ?? '?'}`);
                    createCell(row, 'map', server.map || '未知');
                    createCell(row, 'version', server.version || '未知');
                    createCell(row, 'latency', server.latency ?? '未知');
                }

                // 设置 zero-players 类
                row.classList.toggle('zero-players', isZeroPlayers);
                row.dataset.key = key;
                // 重新插入到 tbody，保证顺序
                tbody.appendChild(row);
            });

            // 删除旧行
            existingRows.forEach((row, key) => {
                if (!updatedKeys.has(key)) {
                    tbody.removeChild(row);
                }
            });
        }

        function updateCellContent(cell, newContent) {
            const contentStr = String(newContent);
            if (cell.textContent !== contentStr) {
                cell.textContent = contentStr;
            }
        }

        function createCell(row, className, textContent = '') {
            const cell = row.insertCell();
            cell.className = className;
            cell.textContent = textContent;
            return cell;
        }

        function updateLastUpdateTime() {
            lastUpdateTime = Date.now();
            lastUpdatedDiv.classList.remove('hidden');
            updateTimeSpan.textContent = '0';
        }

        function startUpdateTimer() {
             clearInterval(updateTimerInterval);
             updateTimerInterval = setInterval(() => {
                if (lastUpdateTime) {
                    const secondsAgo = Math.floor((Date.now() - lastUpdateTime) / 1000);
                    updateTimeSpan.textContent = secondsAgo;
                }
            }, 1000);
        }

        async function refreshServers() {
            const refreshBtn = document.querySelector('.refresh-btn');
            refreshBtn.disabled = true;
            const originalStatus = statusDiv.textContent;
             if (!reconnectCountdownIntervalId) {
                 startLoadingAnimation('正在请求刷新...');
             }

            try {
                await axios.get('/api/servers');
                 setTimeout(() => {
                      refreshBtn.disabled = false;
                      if (!reconnectCountdownIntervalId && statusDiv.textContent.startsWith('正在请求刷新')) {
                          statusDiv.textContent = originalStatus;
                      }
                 }, 3000);
            } catch (error) {
                console.error("Error requesting server refresh:", error);
                 if (!reconnectCountdownIntervalId) {
                    stopLoadingAnimation('刷新请求失败');
                 }
                 refreshBtn.disabled = false;
            }
        }

        window.onload = () => {
             urlParams = parseURLParams();
             loadCachedData();
             startUpdateTimer();
             connectWebSocket();
        };

        document.addEventListener('click', (event) => {
            if (!gameFilter.contains(event.target)) gameFilter.classList.remove('open');
            if (!regionFilter.contains(event.target)) regionFilter.classList.remove('open');
            if (!sortDropdown.contains(event.target)) sortDropdown.classList.remove('open');
        });
    </script>
</body>
</html>
